<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Apiman Migration Guide :: Apiman Documentation</title>
    <link rel="canonical" href="https://www.apiman.io/apiman-docs/migration-guide/latest/migrations.html">
    <meta name="generator" content="Antora 3.0.3">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="stylesheet" href="../../_/css/site-extra.css">
<link rel="stylesheet" href="../../_/css/vendor/docsearch.min.css">
<link rel="stylesheet" href="../../_/js/vendor/docsearch.min.js">
<link rel="icon" href="../../favicon.ico" type="image/x-icon">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TRD82LC9Y2"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-TRD82LC9Y2')</script>
    <script>var uiRootPath = '../../_'</script>
<link rel="icon" href="../../_/img/apiman/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div id="apiman-logo"></div>
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.apiman.io/apiman-docs">Apiman Documentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
      <div class="navbar-item hide-for-print">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://www.apiman.io/latest/index.html">Home</a>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="https://www.apiman.io/latest/download.html">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="migration-guide" data-version="3.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="migrations.html">Migration Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="migrations.html">Apiman Migration Guide</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Migration Guide</span>
    <span class="version">3.1.0-SNAPSHOT</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../guides/latest/index.html">Apiman Guides</a>
      <ul class="versions">
        <li class="version">
          <a href="../../guides/dev/index.html">3.1.0-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../../guides/latest/index.html">3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../development-guide/latest/intro.html">Development Guide</a>
      <ul class="versions">
        <li class="version">
          <a href="../../development-guide/dev/intro.html">3.1.0-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../../development-guide/latest/intro.html">3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../installation-guide/latest/index.html">Installation Guide</a>
      <ul class="versions">
        <li class="version">
          <a href="../../installation-guide/dev/index.html">3.1.0-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../../installation-guide/latest/index.html">3</a>
        </li>
        <li class="version">
          <a href="../../installation-guide/2.2.3.Final/index.html">2.2.3.Final</a>
        </li>
        <li class="version">
          <a href="../../installation-guide/1.5.7.Final/index.html">1.5.7.Final</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../latest/migrations.html">Migration Guide</a>
      <ul class="versions">
        <li class="version is-current">
          <a href="migrations.html">3.1.0-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../latest/migrations.html">3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../user-guide/latest/index.html">User Guide</a>
      <ul class="versions">
        <li class="version">
          <a href="../../user-guide/dev/index.html">3.1.0-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../../user-guide/latest/index.html">3</a>
        </li>
        <li class="version">
          <a href="../../user-guide/2.2.3.Final/index.html">2.2.3.Final</a>
        </li>
        <li class="version">
          <a href="../../user-guide/1.5.7.Final/index.html">1.5.7.Final</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../guides/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="migrations.html">Migration Guide</a></li>
    <li><a href="migrations.html">Apiman Migration Guide</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">3.1.0-SNAPSHOT</button>
  <div class="version-menu">
    <a class="version is-current" href="migrations.html">3.1.0-SNAPSHOT</a>
    <a class="version" href="../latest/migrations.html">3</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/apiman/apiman/edit/master/docs/migration/modules/ROOT/pages/migrations.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Apiman Migration Guide</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Notes for upgrading to newer versions of Apiman.
Unless stated otherwise, the instructions assume that you are upgrading sequentially version to version.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating-to-3-0-0-final"><a class="anchor" href="#migrating-to-3-0-0-final"></a>Migrating to 3.0.0.Final</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To migrate from Apiman 2.x to 3.0.0.Final, please use Apiman&#8217;s export-import function.</p>
</div>
<div class="sect2">
<h3 id="breaking-changes"><a class="anchor" href="#breaking-changes"></a>Breaking Changes</h3>
<div class="sect3">
<h4 id="elasticsearch-support-removed-for-apiman-manager-backend-storage"><a class="anchor" href="#elasticsearch-support-removed-for-apiman-manager-backend-storage"></a>Elasticsearch support removed for Apiman Manager backend storage</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This does <strong>not</strong> affect Apiman Metrics or any of the Apiman Gateway.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Elasticsearch is no longer supported as a primary datastore for the Apiman Manager. Only relational databases are supported.</p>
</div>
<div class="paragraph">
<p>For a fuller explanation of why we made this decision, please refer to <a href="https://github.com/apiman/apiman/discussions/1365" target="_blank" rel="noopener"><em>AEP 2: Drop Elasticsearch as Manager API database in Apiman 3 (keep for metrics, gateway, etc)</em></a>.</p>
</div>
<div class="paragraph">
<p>In your <code>apiman.properties</code>, you must now use JPA for the storage type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">apiman-manager.storage.type=jpa</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please refer to the documentation to see how you can configure Apiman to use your database of choice.</p>
</div>
<div class="paragraph">
<p>To reiterate, this does not affect metrics or the Apiman Gateway registry, components, etc.</p>
</div>
</div>
<div class="sect3">
<h4 id="apiman-wildfly-quickstart-overlays-are-no-longer-bundled-with-keycloak"><a class="anchor" href="#apiman-wildfly-quickstart-overlays-are-no-longer-bundled-with-keycloak"></a>Apiman WildFly quickstart overlays are no longer bundled with Keycloak</h4>
<div class="paragraph">
<p>Keycloak has deprecated the Keycloak server overlay, which allowed us to bundle Keycloak and Apiman in the same overlay.</p>
</div>
<div class="paragraph">
<p>This is no longer supported by the Keycloak team, and hence we have been forced to follow suit to avoid shipping an insecure version of Keycloak.</p>
</div>
<div class="paragraph">
<p>We have replaced this with a Docker Compose quickstart distribution that runs Keycloak as a standalone container.
This should be equally convenient for users, whilst also being more secure and a better representation of a production setup.</p>
</div>
</div>
<div class="sect3">
<h4 id="apiman-docker-all-in-one-images-are-deprecated"><a class="anchor" href="#apiman-docker-all-in-one-images-are-deprecated"></a>Apiman Docker all-in-one images are deprecated</h4>
<div class="paragraph">
<p>Historically, for quickstart purposes we shipped all components required for a simple Apiman deployment into the same container.</p>
</div>
<div class="paragraph">
<p>Whilst convenient for a quick tryout, it causes significant issues with security and configuration, whilst making it awkward to transition to a full production setup.</p>
</div>
<div class="paragraph">
<p>We have replaced this with a Docker Compose quickstart distribution comprised of individual components, each hosted in their own container.</p>
</div>
<div class="paragraph">
<p>This also makes scaling Apiman easier out-of-the-box, as the gateway containers can be scaled independently of the manager.</p>
</div>
<div class="paragraph">
<p>Please refer to the Apiman documentation for further information.</p>
</div>
</div>
<div class="sect3">
<h4 id="minimum-database-versions"><a class="anchor" href="#minimum-database-versions"></a>Minimum database versions</h4>
<div class="paragraph">
<p>For PostgreSQL, 11 is now the minimum required database version.
All versions from 11 to 14 seem to work well (the latest major version as of writing).</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating-to-2-2-3-final"><a class="anchor" href="#migrating-to-2-2-3-final"></a>Migrating to 2.2.3.Final</h2>
<div class="sectionbody">
<div class="paragraph">
<p>No special action should be required, although backing up is always recommended.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating-to-2-2-2-final"><a class="anchor" href="#migrating-to-2-2-2-final"></a>Migrating to 2.2.2.Final</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Issues with the release process meant this version number was skipped.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating-to-2-2-1-final"><a class="anchor" href="#migrating-to-2-2-1-final"></a>Migrating to 2.2.1.Final</h2>
<div class="sectionbody">
<div class="paragraph">
<p>No special action should be required, although backing up is always recommended.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating-to-2-2-0-final"><a class="anchor" href="#migrating-to-2-2-0-final"></a>Migrating to 2.2.0.Final</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="wildfly-keycloak"><a class="anchor" href="#wildfly-keycloak"></a>WildFly &amp; Keycloak</h3>
<div class="paragraph">
<p>We have bumped WildFly to 23.0.2.Final and Keycloak to 15.1.1.Final for security reasons.</p>
</div>
<div class="paragraph">
<p>If you are using the Apiman WildFly distribution and customised <code>apiman-standalone.xml</code> you <em>may</em> need to update your configuration file.
This is because of changes in the WildFly platform rather than Apiman itself.</p>
</div>
<div class="paragraph">
<p>Presently, we bundle Keycloak in some of our Apiman quickstart distributions.
This is now Keycloak version 15.1.1.Final.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/apiman/apiman/commit/e645b9990ae26f5de15fdaabb1e55b1cbb2b05f3#diff-01645d81b443f3ac51ce6ad78abc3b73f51852ecb9f229a6a968699fcac4c7b2">See the diff of the <code>standalone-apiman.xml</code> to understand what has changed</a>.
This mostly relates to changes in the way SSL/TLS is configured in the underlying WildFly platform.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Most production deployments should unbundle Keycloak and Apiman.</p>
</div>
<div class="paragraph">
<p>In a release in the near future, we will stop bundling Keycloak and Apiman in the quickstarts, and instead we will provide a Docker Compose file that is much more representative of a real-world deployment.</p>
</div>
<div class="paragraph">
<p>This will also mean Apiman is not forced to stay in sync with Keycloak Server releases.
We hope this will be more convenient for Apiman users and the Apiman team.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please visit our <a href="https://github.com/apiman/apiman/discussions">GitHub Discussions forum</a> if you have issues.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating-to-2-1-5-final"><a class="anchor" href="#migrating-to-2-1-5-final"></a>Migrating to 2.1.5.Final</h2>
<div class="sectionbody">
<div class="paragraph">
<p>No special action should be required, although backing up is always recommended.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating-to-2-1-4-final"><a class="anchor" href="#migrating-to-2-1-4-final"></a>Migrating to 2.1.4.Final</h2>
<div class="sectionbody">
<div class="paragraph">
<p>No special action should be required, although backing up is always recommended.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating-to-2-1-3-final"><a class="anchor" href="#migrating-to-2-1-3-final"></a>Migrating to 2.1.3.Final</h2>
<div class="sectionbody">
<div class="paragraph">
<p>No special action should be required, although backing up is always recommended.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating-to-2-1-2-final"><a class="anchor" href="#migrating-to-2-1-2-final"></a>Migrating to 2.1.2.Final</h2>
<div class="sectionbody">
<div class="paragraph">
<p>No special action should be required, although backing up is always recommended.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating-to-2-1-1-final"><a class="anchor" href="#migrating-to-2-1-1-final"></a>Migrating to 2.1.1.Final</h2>
<div class="sectionbody">
<div class="paragraph">
<p>No special action should be required, although backing up is always recommended.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="migrating-to-2-1-0-final"><a class="anchor" href="#migrating-to-2-1-0-final"></a>Migrating to 2.1.0.Final</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If upgrading to Apiman 2.1.0.Final from a prior version.</p>
</div>
<div class="sect2">
<h3 id="manual-action-required"><a class="anchor" href="#manual-action-required"></a>Manual action required</h3>
<div class="sect3">
<h4 id="fixing-pre-2-1-0-final-apiman-export-files"><a class="anchor" href="#fixing-pre-2-1-0-final-apiman-export-files"></a>Fixing pre-2.1.0.Final Apiman export files</h4>
<div class="paragraph">
<p>In older versions of Apiman Manager export files were missing their Api Definition schemas (Swagger, OpenAPI, etc).</p>
</div>
<div class="paragraph">
<p>We have provided a migration assistant CLI tool in order to fix this.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download an Apiman distro (e.g. Tomcat, Wildfly).</p>
</li>
<li>
<p>In the <code>apiman</code> folder you will find a file called <code>migration-assistant-cli.jar</code>.</p>
</li>
<li>
<p>You can run the tool as follows. Note that it should be run against the <strong>older/existing installation</strong> (i.e. pre-2.1.0.Final):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ java -jar migration-assistant-cli.jar export upgrade \
  --username=admin <i class="conum" data-value="1"></i><b>(1)</b>
  --password=admin123! <i class="conum" data-value="2"></i><b>(2)</b>
  --endpoint=http://localhost:8080/apiman <i class="conum" data-value="3"></i><b>(3)</b>
  --output=/home/myuser/fixed-export.json <i class="conum" data-value="4"></i><b>(4)</b>
  --trust-all <i class="conum" data-value="5"></i><b>(5)</b>

# or use it directly as a docker container
$ docker run --rm -it ghcr.io/ghcr.io/apiman/migration-assistant export upgrade &lt;...&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>An Apiman user with administrator privileges.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Password.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Apiman Manager API endpoint of your <strong>old version of Apiman</strong>, often this is your bound hostname followed by <code>/apiman</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Where to write the enriched export JSON.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Whether to trust all certificates and hostnames (when using TLS).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This initial version of the migration assistant tool does nothing other than this enrichment operation.</p>
</div>
<div class="paragraph">
<p>Once the operation is completed, you can import the file into Apiman 2.1.0.Final and the API definitions will be present.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="elasticsearch"><a class="anchor" href="#elasticsearch"></a>Elasticsearch</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Apiman 2.1.0.Final requires now Elasticsearch 7.x
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you are using Elasticsearch for the Apiman Manager API backend and/or metrics, the following sections are important to pay close attention to.</p>
</div>
<div class="paragraph">
<p>Over time, it has become increasingly more difficult to maintain backwards compatibility between different versions of Elasticsearch due to frequent changes to all aspects of the database in the upstream (schemas, types, etc).</p>
</div>
<div class="paragraph">
<p>Please pay close attention to the instructions, as Elasticsearch can be very selective which versions work properly during an upgrade process.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Consider backing up your data before taking any action.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="option-1-discarding-metrics-5-x-to-7-x"><a class="anchor" href="#option-1-discarding-metrics-5-x-to-7-x"></a>Option 1: Discarding Metrics (5.X to 7.X)</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This will result in data loss, please ensure this data is not important before dropping any indices.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the existing metrics are not important for you:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Drop your current 5.X installation completely or delete the indexes:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>apiman_metrics</code></p>
</li>
<li>
<p><code>apiman_manager</code></p>
</li>
<li>
<p><code>apiman_gateway</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Use the latest 7.X version of Elasticsearch for a fresh start</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="option-2-keeping-metrics-5-x-to-7-x"><a class="anchor" href="#option-2-keeping-metrics-5-x-to-7-x"></a>Option 2: Keeping Metrics (5.X to 7.X)</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Enabling the Elasticsearch <code>xpack</code> features may change the license that you are running Elasticsearch under. Users should perform appropriate due diligence.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to keep your metrics follow the steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure you have the latest version of Elasticsearch 5.x (5.6.16). You have to be at least on this version.</p>
</li>
<li>
<p>Update Elasticsearch 5.6.16 to <strong>6.8.16</strong> with <code>xpack</code> enabled.</p>
</li>
<li>
<p>Make sure you have installed kibana in the same version (6.8.16 with <code>xpack</code> enabled)</p>
</li>
<li>
<p>Run the migration assistant as explained here to prepare to update to the required version of Elasticsearch 7.X <a href="https://www.elastic.co/guide/en/kibana/6.8/upgrade-assistant.html" class="bare">www.elastic.co/guide/en/kibana/6.8/upgrade-assistant.html</a></p>
</li>
<li>
<p>Delete the index <code>apiman_manager</code> and <code>apiman_gateway</code> in kibana. Do <strong>not</strong> delete <code>apiman_metrics</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="7-x-notes"><a class="anchor" href="#7-x-notes"></a>7.X Notes</h4>
<div class="paragraph">
<p>A bug was introduced in the schema definition in 2.0.0.Final.</p>
</div>
<div class="paragraph">
<p>If you are already on Elasticsearch 7.X, then make sure you run an export, and drop/reindex the indexes <code>apiman_manager</code> and <code>apiman_gateway</code>.</p>
</div>
<div class="paragraph">
<p>Metrics should be unaffected.</p>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>Content copyright of respective contributors to the <a href="http://www.github.com/apiman/apiman">Apiman</a> project</p>
  <p>This page was built using the <a href="https://antora.org/" target="_blank">Antora</a> documentation site generator. We are extremely grateful to the Antora team for creating this wonderful project!</p>
</footer>

<link rel="stylesheet" href="../../_/css/vendor/site-extra.css">
<script src="../../_/js/vendor/docsearch.min.js"></script>
<script>
var search = docsearch({
  appId: 'AAYCL8CIXA',
  apiKey: '28b004058c83c0723c196eccfb86490d',
  indexName: 'docsearch-apiman',
  inputSelector: '#search-input',
  autocompleteOptions: { hint: false, keyboardShortcuts: ['s'] },
  algoliaOptions: { hitsPerPage: 10 }
})
</script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
