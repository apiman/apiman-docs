<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Security :: Apiman Documentation</title>
    <link rel="canonical" href="https://www.apiman.io/apiman-docs/installation-guide/latest/gateway/security.html">
    <link rel="prev" href="../registries-and-components/headless.html">
    <link rel="next" href="../how-to/jdbc.html">
    <meta name="generator" content="Antora 3.0.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../_/css/vendor/docsearch.min.css">
<link rel="stylesheet" href="../../../_/js/vendor/docsearch.min.js">
<link rel="icon" href="../../../favicon.ico" type="image/x-icon">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TRD82LC9Y2"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-TRD82LC9Y2')</script>
    <script>var uiRootPath = '../../../_'</script>
<link rel="icon" href="../../../_/img/apiman/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div id="apiman-logo"></div>
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.apiman.io/apiman-docs">Apiman Documentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
      <div class="navbar-item hide-for-print">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://www.apiman.io/latest/index.html">Home</a>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="https://www.apiman.io/latest/download.html">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="installation-guide" data-version="3.2">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Installation Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Installation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quickstart.html">Quickstart</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../keycloak.html">Set up Keycloak SSO</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Apiman Platforms</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../servlet/wildfly.html">WildFly</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../servlet/wildfly.html#_download">Download &amp; Launch</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../servlet/wildfly.html#_installing_using_docker">Docker</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../servlet/config-guide.html">Config Guide</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../vertx/download.html">Vert.x Gateway</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vertx/download.html#_download_launch">Download &amp; Launch</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../vertx/download.html#_configurations">Configurations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../vertx/download.html#_elasticsearch">Elasticsearch</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../vertx/download.html#_headless_elasticsearch">Headless ES</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vertx/install.html">Installation Walkthrough</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vertx/config-guide.html">Config Guide</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Apiman Manager</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../manager/database.html">Database Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../manager/configuration.html">Apiman Customisation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../manager/notifications.html">Notifications</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../manager/portal.html">Developer Portal</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../manager/backup-migration.html">Backup &amp; Migration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../manager/backup-migration.html#_upgrading_to_a_new_apiman_version">Upgrading Apiman</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Apiman Gateway</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../registries-and-components/overview.html">Registries &amp; Components</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../registries-and-components/jdbc.html">JDBC / SQL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../registries-and-components/elasticsearch.html">Elasticsearch</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../registries-and-components/influxdb.html">InfluxDB Metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../registries-and-components/hazelcast.html">Hazelcast</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../registries-and-components/prometheus.html">Prometheus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../registries-and-components/redis.html">Redis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../registries-and-components/headless.html">Headless</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="security.html">Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_gateway_api_authentication">Gateway API Authentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_mtls_mutual_ssl_endpoint_security">Mutual TLS (mTLS)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">How to</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../how-to/jdbc.html">SQL Metrics Instead of Elasticsearch</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../production.html">Production Guide</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../manager/production-manager.html">WildFly Manager</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="production-gateway-wildfly.html">WildFly Gateway</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="production-gateway.html">Vert.x Gateway</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Installation Guide</span>
    <span class="version">3.2.0-SNAPSHOT</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../guides/latest/index.html">Apiman Guides</a>
      <ul class="versions">
        <li class="version">
          <a href="../../../guides/dev/index.html">3.2.0-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../../../guides/latest/index.html">3.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../development-guide/latest/intro.html">Development Guide</a>
      <ul class="versions">
        <li class="version">
          <a href="../../../development-guide/dev/intro.html">3.2.0-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../../../development-guide/latest/intro.html">3.1</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../latest/index.html">Installation Guide</a>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">3.2.0-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../../latest/index.html">3.1</a>
        </li>
        <li class="version">
          <a href="../../2.2.3.Final/index.html">2.2.3.Final</a>
        </li>
        <li class="version">
          <a href="../../1.5.7.Final/index.html">1.5.7.Final</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../migration-guide/latest/migrations.html">Migration Guide</a>
      <ul class="versions">
        <li class="version">
          <a href="../../../migration-guide/dev/migrations.html">3.2.0-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../../../migration-guide/latest/migrations.html">3.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../user-guide/latest/index.html">User Guide</a>
      <ul class="versions">
        <li class="version">
          <a href="../../../user-guide/dev/index.html">3.2.0-SNAPSHOT</a>
        </li>
        <li class="version is-latest">
          <a href="../../../user-guide/latest/index.html">3.1</a>
        </li>
        <li class="version">
          <a href="../../../user-guide/2.2.3.Final/index.html">2.2.3.Final</a>
        </li>
        <li class="version">
          <a href="../../../user-guide/1.5.7.Final/index.html">1.5.7.Final</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../guides/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Installation Guide</a></li>
    <li>Apiman Gateway</li>
    <li><a href="security.html">Security</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">3.2.0-SNAPSHOT</button>
  <div class="version-menu">
    <a class="version is-current" href="security.html">3.2.0-SNAPSHOT</a>
    <a class="version" href="../../latest/gateway/security.html">3.1</a>
    <a class="version" href="../../2.2.3.Final/gateway/security.html">2.2.3.Final</a>
    <a class="version" href="../../1.5.7.Final/gateway/security.html">1.5.7.Final</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/apiman/apiman/edit/master/docs/installation/modules/ROOT/pages/gateway/security.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Security</h1>
<div class="sect1">
<h2 id="keycloak-idm"><a class="anchor" href="#keycloak-idm"></a>Keycloak IDM</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As of Apiman 3, we no longer bundle the Keycloak server into Apiman quickstart distributions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to use the Apiman quickstarts, you need to run Keycloak.</p>
</div>
<div class="paragraph">
<p><a href="https://www.keycloak.org" target="_blank" rel="noopener">Keycloak</a> is used to manage a range of security tasks for Apiman, including user account management, login security, OIDC provider, etc.</p>
</div>
<div class="paragraph">
<p>To provide flexibility, there are a few ways you can configure Apiman to point to your Keycloak server.</p>
</div>
<div class="sect2">
<h3 id="kc-configuration-options"><a class="anchor" href="#kc-configuration-options"></a>Configuration</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Required Params</caption>
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 14.2857%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>System property: apiman.auth.realm</p>
</li>
<li>
<p>Env var: APIMAN_AUTH_REALM</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Keycloak realm name.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Default Value</strong>: apiman</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>System property: apiman.auth.url</p>
</li>
<li>
<p>Env var: APIMAN_AUTH_URL</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Keycloak auth server URL</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In older versions of Keycloak the auth server might have <code>/auth</code> at the end of the URL, rather than being at root (i.e. <code><a href="http://old-keycloak:8080/auth" class="bare">old-keycloak:8080/auth</a></code> vs <code><a href="http://new-keycloak:8080/auth" class="bare">new-keycloak:8080/auth</a></code>).
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>System property: apiman.auth.api.secret</p>
</li>
<li>
<p>Env var: APIMAN_AUTH_API_SECRET</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Keycloak secret credential for the Apiman Manager API (<code>apiman</code> client)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Default Value</strong>: password</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>System property: apiman.auth.ui.secret</p>
</li>
<li>
<p>Env var: APIMAN_AUTH_UI_SECRET</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Keycloak secret credential for the Apiman Manager UI (<code>apimanui</code> client)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Default Value</strong>: password</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>System property: apiman.auth.gateway.secret</p>
</li>
<li>
<p>Env var: APIMAN_AUTH_GATEWAY_SECRET</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Keycloak secret credential for the Apiman Gateway API (<code>apiman-gateway-api</code> client)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Default Value</strong>: password</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>System property: apiman.auth.realm-public-key</p>
</li>
<li>
<p>Env var: APIMAN_AUTH_REALM_PUBLIC_KEY</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Public key for Apiman realm (only needed on Vert.x Gateway).</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Default Value</strong>: example Apiman realm key</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please change default secrets and keys before deploying Apiman to production.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="setting-up-keycloak"><a class="anchor" href="#setting-up-keycloak"></a>Setting up Keycloak</h3>
<div class="paragraph">
<p>As a quick way to run Keycloak and initialise it with the Apiman&#8217;s default realm, here&#8217;s an example Docker Compose file:</p>
</div>
<div class="listingblock">
<div class="title">Example Docker Compose file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">services:
  keycloak:
    container_name: keycloak_server_all
    image: quay.io/keycloak/keycloak:18.0.2
    entrypoint: ['/bin/bash', '-c']
    command:
      - |
        cd /opt/keycloak
        ./bin/kc.sh build
        ./bin/kc.sh start-dev --import-realm
    ports:
      - "8085:8080"
    environment:
      - "KEYCLOAK_ADMIN=admin"
      - "KEYCLOAK_ADMIN_PASSWORD=admin123!"
      - "KEYCLOAK_FRONTEND_URL=http://localhost:8085"
    volumes:
      - ${PWD}/apiman-realm-for-keycloak.json:/opt/keycloak/data/import/apiman-realm-for-keycloak.json <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Copy <code>apiman-realm-for-keycloak.json</code> from <code>apiman/data/apiman-realm-for-keycloak.json</code>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a file called <code>docker-compose.yml</code> with the contents shown above.</p>
</li>
<li>
<p>Copy <code>apiman/data/apiman-realm-for-keycloak.json</code> from your distro zip to the same directory as your <code>docker-compose.yml</code>.</p>
</li>
<li>
<p>Start with <code>docker-compose up</code>.</p>
</li>
<li>
<p>You should now have Keycloak running on localhost port 8085</p>
</li>
<li>
<p>Try it with: <code><a href="http://localhost:8085/admin" class="bare">localhost:8085/admin</a></code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Admin username: <code>admin</code></p>
</li>
<li>
<p>Admin password: <code>admin123!</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Your Apiman Auth URL is: <code><a href="http://localhost:8085" class="bare">localhost:8085</a></code> (see <a href="#kc-configuration-options">Configuration</a>)</p>
</li>
</ol>
</div></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is running in dev mode. For production, refer to the Keycloak Production Guides.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_gateway_api_authentication"><a class="anchor" href="#_gateway_api_authentication"></a>Gateway API Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Apiman Gateway&#8217;s REST API is what the API Manager invokes when publishing APIs and Client Apps to the Gateway <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The quickstart configurations should work out of the box, but they assume the locality of all components.</p>
</div>
<div class="paragraph">
<p>Real deployments will likely need to perform some reconfiguration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This REST API should be protected, usually by BASIC authentication.</p>
</div>
<div class="paragraph">
<p>By default, the Apiman Gateway REST API requires BASIC authentication credentials, as well as a role of <code>apipublisher</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Apiman Gateway REST API can only be invoked by a valid user, and that user must have the <code>apipublisher</code> role.</p>
</li>
<li>
<p>The Keycloak client for this API is <code>apiman-gateway-api</code></p>
<div class="ulist">
<ul>
<li>
<p>The default user is: <strong>apimanager</strong></p>
</li>
<li>
<p>The default password is: <strong>apiman123!</strong></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="advanced-setup"><a class="anchor" href="#advanced-setup"></a>Advanced Setup</h3>
<div class="paragraph">
<p>For more advanced setups, the environment variables/system properties may not be sufficient; manual editing of configuration files might be necessary.</p>
</div>
<div class="sect3">
<h4 id="vert-x-gateway"><a class="anchor" href="#vert-x-gateway"></a>Vert.x Gateway</h4>
<div class="paragraph">
<p>For the Vert.x gateway, the simplest way to retrieve the necessary configuration is to generate it from your Keycloak server.</p>
</div>
<div class="paragraph">
<p>The gateway accepts Keycloak&#8217;s generated JSON, allowing you to paste your chosen client configuration from the Keycloak console into the <code>auth.config</code> section.</p>
</div>
<div class="paragraph">
<p>To retrieve it:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log into your Keycloak Administrator console (e.g <a href="http://localhost:8085/admin" class="bare">localhost:8085/admin</a>).</p>
</li>
<li>
<p><code>Clients</code> &#8594; <code>apiman-gateway-api</code> &#8594; <code>Installation</code>.</p>
</li>
<li>
<p>Select <code>Keycloak OIDC JSON</code> for <code>Format Option</code>.</p>
</li>
<li>
<p>Copy the contents and merge into the <code>config</code> selection where indicated below.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The precise configuration you need to provide will vary depending upon your Keycloak setup.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Due to a current limitation in the underlying OAuth2 library you may be required to provide a <code>credentials</code> section to avoid issues.</p>
</div>
<div class="paragraph">
<p>You can change your client type to <code>confidential</code>, or simply provide a dummy <code>credentials</code> section.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json5 hljs" data-lang="json5">"auth": {
  "type": "keycloak",
  "config": {
    "flowType": "PASSWORD",
    "requiredRole": "realm:apipublisher",
    // Paste and overwrite your Keycloak config here.
    "realm": "apiman",
    "realm-public-key": "&lt;snip&gt;",
    "auth-server-url": "http://localhost:8080/auth",
    "ssl-required": "none",
    "resource": "apiman-gateway-api",
    // A limitation in the current OAuth2 implementation means a credentials section is required
    // even if your client is not set to "confidential". Leave this dummy section if you're using non-confidential.
    "credentials": {
      "secret": "217b725d-7790-47a7-a3fc-5cf31f92a8db"
    }
    // End paste here
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="servlet-gateway"><a class="anchor" href="#servlet-gateway"></a>Servlet Gateway</h4>
<div class="paragraph">
<p>The API Gateway has a REST based configuration API which the API Manager uses when publishing APIs to it.
This API is protected by Keycloak authentication.</p>
</div>
<div class="paragraph">
<p>Most options can be configured using environment variables or system properties, rather than editing configuration directly. Please see the <a href="#kc-configuration-options">Keycloak Configuration Options</a> section for details.</p>
</div>
<div class="paragraph">
<p>If not, the relevant portion of the <strong>standalone-apiman.xml</strong> file that you must change is <code>keycloak</code> subsystem.
It looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;realm name="apiman"&gt;
  &lt;auth-server-url&gt;https://keycloak-host.org:8443&lt;/auth-server-url&gt;
  &lt;ssl-required&gt;none&lt;/ssl-required&gt;
  &lt;enable-cors&gt;false&lt;/enable-cors&gt;
  &lt;principal-attribute&gt;preferred_username&lt;/principal-attribute&gt;
&lt;/realm&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mtls_mutual_ssl_endpoint_security"><a class="anchor" href="#_mtls_mutual_ssl_endpoint_security"></a>MTLS (Mutual SSL) Endpoint Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you wish to use mutual SSL to ensure endpoint security between the Apiman API Gateway and your back-end API(s), you must update some settings.</p>
</div>
<div class="sect2">
<h3 id="high-level-overview"><a class="anchor" href="#high-level-overview"></a>High Level Overview</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create Trust and Key Stores</p>
</li>
<li>
<p>Make changes to your config file</p>
</li>
<li>
<p>(Re)start Apiman!</p>
</li>
<li>
<p>Configure one or more API to use MTLS</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="create-trust-and-key-stores"><a class="anchor" href="#create-trust-and-key-stores"></a>Create Trust and Key Stores</h3>
<div class="paragraph">
<p>Please refer to <a href="https://docs.oracle.com/javase/7/docs/technotes/tools/solaris/keytool.html">official JDK documentation</a> to learn how to create and managed your SSL Trust and Key stores.
Minimally a Keystore is required in order to successfully utilise MTLS, and in many cases also a Truststore.</p>
</div>
<div class="paragraph">
<p>A <strong>keystore</strong> contains a given node&#8217;s private key material, and must be kept safe.
Each node should have a unique key entry.
For instance, a gateway should have its own keystore, and each API likewise.
In a production system, these keys should be issued by a trusted certificate authority.</p>
</div>
<div class="paragraph">
<p>A <strong>truststore</strong> typically contains a set of certificate authorities which are trusted issuers.
Therefore, any certificate signed by the trusted CA would be trusted by the gateway.
If no truststore is explicitly provided to Apiman the
<a href="https://docs.oracle.com/javase/7/docs/technotes/tools/solaris/keytool.html#cacerts">default trusted certificates</a> provided by the JVM will be used.
A typical use-case would be that an organization&#8217;s internal signing authority is marked as trusted within in the truststore, and as the authority has been used to sign the certificate material in the keystores, they will mutually trust each other by virtue of the issuer.</p>
</div>
<div class="paragraph">
<p>It is also possible to directly insert the <strong>public/self-signed certificate</strong> corresponding to a given private key pair into a truststore, which works well at small scales and for development, but will quickly cause the accumulation of a huge number of certificates in larger systems as it requires a 1:1 mapping of certificates and private keys (rather than 1:N by using a trusted authority).</p>
</div>
<div class="paragraph">
<p>Your back-end APIs must be SSL enabled and <strong>require authenticated client SSL connections</strong>.
This means you must have server SSL certificates generated (and appropriate certificates and/or CAs stored in your Trust Store).</p>
</div>
</div>
<div class="sect2">
<h3 id="example-scenarios"><a class="anchor" href="#example-scenarios"></a>Example Scenarios</h3>
<div class="paragraph">
<p>There are many potential configuration permutations, but we&#8217;ll outline a few simple ones here to get you started. You should research the best options to meet your security and deployment requirements.</p>
</div>
<div class="sect3">
<h4 id="development-setup"><a class="anchor" href="#development-setup"></a>Development Setup</h4>
<div class="paragraph">
<p>In our hypothetical development setup, let&#8217;s imagine we have two APIs and a single gateway.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Simple Development MTLS Setup</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Key Alias</th>
<th class="tableblock halign-left valign-top">Truststore&#8217;s Trusted Certificates</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apiman Gateway</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gateway</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">api_a.cer, api_b.cer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">API A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">api_a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gateway.cer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">API B</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">api_b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gateway.cer</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<div class="title">Walkthrough</div>
<ul>
<li>
<p>Generate a keystore and export a certificate for each component:</p>
<div class="ulist">
<ul>
<li>
<p>Gateway:</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">keytool -genkey -keyalg RSA -keystore gateway_ks.jks -alias gateway
keytool -export -alias gateway -file gateway.cer -keystore gateway_ks.jks</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>API A:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">keytool -genkey -keyalg RSA -keystore api_a_ks.jks -alias api_a
keytool -export -alias api_a -file api_a.cer -keystore api_a_ks.jks</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>API B:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">keytool -genkey -keyalg RSA -keystore api_b_ks.jks -alias api_b
keytool -export -alias api_b -file api_b.cer -keystore api_b_ks.jks</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Import certificates into appropriate trust stores:</p>
<div class="ulist">
<ul>
<li>
<p>Gateway:</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">keytool -import -file api_a.cer -alias api_a -keystore gateway_ts.jks
keytool -import -file api_b.cer -alias api_b -keystore gateway_ts.jks</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>API A:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">keytool -import -file gateway.cer -alias gateway -keystore api_a_ts.jks</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>API B:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">keytool -import -file gateway.cer -alias gateway -keystore api_b_ts.jks</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now simply set the appropriate paths to the keystore and truststore in <code>apiman.properties</code> for the gateway, and set up your APIs with their respective truststores and keystores (the specifics of how to do this will depend on your API&#8217;s implementation).</p>
</div>
<div class="paragraph">
<p>We will also set the following in <code>apiman.properties</code> to make our development easier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">apiman-gateway.connector-factory.tls.allowAnyHost=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you add your MTLS protected APIs into Apiman via the web application, you should set the <code>API Security</code> field to <code>MTLS/Two-Way-SSL</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mtls-via-custom-certificate-authority"><a class="anchor" href="#mtls-via-custom-certificate-authority"></a>MTLS via Custom Certificate Authority</h4>
<div class="paragraph">
<p>The previous approach works for development, but doesn&#8217;t scale well, is harder to manage and doesn&#8217;t gracefully handle revocations, expiry, expansion, etc.
Instead, let&#8217;s summarise a scenario where an organisation has an internal CA which they use to sign APIs' certificates.
The process for generating a CA and signing certificates is out of scope for this guide, but is trivial to accomplish using OpenSSL, LibreSSL, or similar.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s imagine we have a CA called <code>apimanCA</code>, and have <strong>signed</strong> the certificates
for each node.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. CA-based MTLS Setup</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Signed Key Alias</th>
<th class="tableblock halign-left valign-top">Truststore Contents</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apiman Gateway</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gateway (signed by apimanCA)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">apimanCA.cer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">API A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">api_a (signed by apimanCA)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">apimanCA.cer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">API N</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">api_n (signed by apimanCA)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">apimanCA.cer</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Despite the initial administrative work setting up the CA and signing the certificates, this process is drastically less effort to maintain in large deployments.
Only the trusted CA needs to be in the truststore, and any certificates signed by it are trusted by virtue of this.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="make-changes-to-configuration"><a class="anchor" href="#make-changes-to-configuration"></a>Make changes to configuration</h3>
<div class="paragraph">
<p>Once you have your Trust Store and Key Store properly configured, you must alter your configuration file.
Here is a summary of the properties:</p>
</div>
<div class="paragraph">
<p>Omit any properties which are not relevant to you, except <code>trustStore</code>, which is mandatory for MTLS.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The settings chosen here have significant security implications.
Best practice guides are <a href="https://www.owasp.org/">available at OWASP</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="vert-x"><a class="anchor" href="#vert-x"></a>Vert.x</h4>
<div class="listingblock">
<div class="title">conf-es.json</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json5 hljs" data-lang="json5">{
  "connector-factory": {
    "class": "io.apiman.gateway.platforms.vertx3.connector.ConnectorFactory",
    "config": {
      "tls": {
        // Whether self-signed certificates should be automatically trusted. *Use with care.*
        //"allowSelfSigned": true,

        // Developer mode (bypass almost all security checks). *Use with care.*
        //"devMode": false,

        // Whether certificate host checks should be bypassed. *Use with care.*
        //"allowAnyHost": true,

        // Trust store contains certificate(s) trusted by gateway.
        "trustStore": "/path/to/your/truststore.jks",
        "trustStorePassword": "abc123",

        // Key store contains gateway's keys.
        "keyStore": "/path/to/your/keystore.jks",
        "keyStorePassword": "abc123"

        // By default all keys can be used (will try all).
        // If alias list provided, will only attempt to use listed keys.
        //"keyAliases": "mykey,myotherkey",

        // Allowed TLS/SSL protocols and ciphers suites as CSV.
        // Availability will vary depending on your JVM impl.
        // Uses JVM defaults depending if not explicitly provided.
        // See: https://docs.oracle.com/javase/8/docs/technotes/guides/security/SunProviders.html
        //"allowedProtocols": "TLSv1.2,TLSv1.1",
        //"allowedCiphers": "TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,...",
        //"disallowedCiphers": "..."
      }
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="servlet"><a class="anchor" href="#servlet"></a>Servlet</h4>
<div class="listingblock">
<div class="title">apiman.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># ---------------------------------------------------------------------
# SSL/TLS settings for the gateway connector(s).
# ---------------------------------------------------------------------

# Trust store contains certificate(s) trusted by gateway.
apiman-gateway.connector-factory.tls.trustStore=&lt;PATH_TO_TRUST_STORE&gt;
apiman-gateway.connector-factory.tls.trustStorePassword=&lt;PASSWORD_IF_ANY&gt;

# Key store contains gateway's keys (including private components: keep it safe).
apiman-gateway.connector-factory.tls.keyStore=&lt;PATH_TO_KEY_STORE&gt;
apiman-gateway.connector-factory.tls.keyStorePassword=&lt;PASSWORD_IF_ANY&gt; # Password on key store as a whole
apiman-gateway.connector-factory.tls.keyPassword=&lt;PASSWORD_IF_ANY&gt; # Password on specific key(s)
# By default all keys can be used (will try all). If alias list provided, will only attempt to use listed keys.
apiman-gateway.connector-factory.tls.keyAliases=&lt;COMMA_SEPARATED_LIST&gt;

# Allowed TLS/SSL protocols and ciphers suites as CSV. Availability will vary depending on your JVM impl.
# Uses JVM defaults depending if not explicitly provided.
# See: https://docs.oracle.com/javase/7/docs/technotes/guides/security/SunProviders.html
apiman-gateway.connector-factory.tls.allowedProtocols=TLSv1.2,TLSv1.1
apiman-gateway.connector-factory.tls.allowedCiphers=TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,...

# Whether certificate host checks should be bypassed. *Use with great care.*
apiman-gateway.connector-factory.tls.allowAnyHost=false

# Whether self-signed certificates should be automatically trusted. *Use with great care.*
apiman-gateway.connector-factory.tls.allowSelfSigned=false</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="restart-apiman"><a class="anchor" href="#restart-apiman"></a>(Re)start Apiman</h3>
<div class="paragraph">
<p>If Apiman was running, you should stop it now.
Once everything is shutdown, and the changes to <code>apiman.properties</code> have been made, go ahead and start Apiman up again.</p>
</div>
</div>
<div class="sect2">
<h3 id="configure-one-or-more-api-to-use-mtls"><a class="anchor" href="#configure-one-or-more-api-to-use-mtls"></a>Configure one or more API to use MTLS</h3>
<div class="paragraph">
<p>Now that the Apiman MTLS feature has been configured, use the Manager UI to enable MTLS in one or more API.
This can be done on the "Implementation" tab when you are configuring the details of your back-end endpoint (URL, type, and endpoint security).</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Some advanced configurations may interact directly with the Gateway API, whilst others may bypass it entirely by using polling, etc.
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="../registries-and-components/headless.html">Headless</a></span>
  <span class="next"><a href="../how-to/jdbc.html">SQL Metrics Instead of Elasticsearch</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>Content copyright of respective contributors to the <a href="http://www.github.com/apiman/apiman">Apiman</a> project</p>
  <p>This page was built using the <a href="https://antora.org/" target="_blank">Antora</a> documentation site generator. We are extremely grateful to the Antora team for creating this wonderful project!</p>
</footer>

<link rel="stylesheet" href="../../../_/css/vendor/site-extra.css">
<script src="../../../_/js/vendor/docsearch.min.js"></script>
<script>
var search = docsearch({
  appId: 'AAYCL8CIXA',
  apiKey: '28b004058c83c0723c196eccfb86490d',
  indexName: 'docsearch-apiman',
  inputSelector: '#search-input',
  autocompleteOptions: { hint: false, keyboardShortcuts: ['s'] },
  algoliaOptions: { hitsPerPage: 10 }
})
</script>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
